-- tb_filtre_robert.vhd
-- Testbench for Robert filter (Gx + Gy)
-- Reads lena.dat and writes output.dat
-- Professional style with proper reset and file handling

library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;
use std.textio.all;

entity tb_filtre_robert is
end entity;

architecture sim of tb_filtre_robert is

    -- Clock period
    constant CLK_PERIOD : time := 10 ns;

    -- DUT signals
    signal clk         : std_logic := '0';
    signal rst         : std_logic := '1';
    signal pixel_in    : std_logic_vector(7 downto 0) := (others => '0');
    signal valid_in    : std_logic := '0';
    signal line_start  : std_logic := '0';
    signal frame_start : std_logic := '0';

    signal gx_out      : signed(8 downto 0);
    signal gy_out      : signed(8 downto 0);
    signal valid_out   : std_logic;

    -- File variables
    file infile  : text open read_mode is "lena.dat";
    file outfile : text open write_mode is "output.dat";

begin

    --------------------------------------------------------------------------
    -- Clock generation
    --------------------------------------------------------------------------
    clk_process : process
    begin
        while true loop
            clk <= '0';
            wait for CLK_PERIOD / 2;
            clk <= '1';
            wait for CLK_PERIOD / 2;
        end loop;
    end process;

    --------------------------------------------------------------------------
    -- Instantiate DUT (top module)
    --------------------------------------------------------------------------
    uut: entity work.filtre_robert_top
        port map (
            clk         => clk,
            rst         => rst,
            pixel_in    => pixel_in,
            valid_in    => valid_in,
            line_start  => line_start,
            frame_start => frame_start,
            gx_out      => gx_out,
            gy_out      => gy_out,
            valid_out   => valid_out
        );

    --------------------------------------------------------------------------
    -- Stimulus process: read lena.dat and feed pixels
    --------------------------------------------------------------------------
    stim_proc: process
        variable infile_line : line;
        variable pixel_val   : integer;
        constant IMG_WIDTH   : integer := 128;
        constant IMG_HEIGHT  : integer := 128;
    begin
        -- Apply reset
        rst <= '1';
        wait for 20 ns;
        rst <= '0';
        wait for CLK_PERIOD;

        -- Frame start at first pixel
        frame_start <= '1';
        wait for CLK_PERIOD;
        frame_start <= '0';

        -- Feed image pixels
        for row in 0 to IMG_HEIGHT-1 loop
            for col in 0 to IMG_WIDTH-1 loop
                if endfile(infile) then
                    report "End of file reached too early!" severity warning;
                    pixel_val := 0;
                else
                    readline(infile, infile_line);
                    read(infile_line, pixel_val);
                end if;

                -- Apply pixel to DUT
                pixel_in   <= std_logic_vector(to_unsigned(pixel_val, 8));
                valid_in   <= '1';
                if col = 0 then
                    line_start <= '1';
                else
                    line_start <= '0';
                end if;

                wait until rising_edge(clk);
            end loop;
        end loop;

        -- Stop feeding pixels
        valid_in <= '0';
        line_start <= '0';
        report "All pixels fed to DUT";
        wait for 100 ns;

        wait; -- finish simulation
    end process;

    --------------------------------------------------------------------------
    -- Output writing process
    --------------------------------------------------------------------------
    write_proc: process(clk)
        variable outfile_line : line;
    begin
        if rising_edge(clk) then
            if valid_out = '1' then
                -- Write Gx
                write(outfile_line, integer(gx_out));
                writeline(outfile, outfile_line);
                -- Write Gy
                write(outfile_line, integer(gy_out));
                writeline(outfile, outfile_line);
            end if;
        end if;
    end process;

end architecture sim;
